<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live CFB Scores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .team-logo {
            width: 28px;
            height: 28px;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 min-h-screen flex flex-col items-center">

    <div class="container mx-auto max-w-5xl w-full p-2 sm:p-4">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-2">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-600">Live College Football Scores</span>
            </h1>
            <p id="last-updated" class="text-sm text-gray-400 mt-2">Fetching latest scores...</p>
        </header>

        <main id="scores-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Loading placeholder -->
            <div class="col-span-full text-center p-8">
                <div class="animate-pulse text-blue-400">Loading live scores...</div>
            </div>
        </main>

        <div id="error-message" class="hidden text-center text-red-400 bg-red-900/50 border border-red-700 rounded-lg p-4 mt-8">
            <!-- Error messages will be displayed here -->
        </div>

        <footer class="mt-12 text-center text-gray-500 text-xs">
            <p>Data provided by College Football Data API. Automatically refreshing every 60 seconds.</p>
        </footer>
    </div>

    <script>
        const apiKey = 'hqFOKo3xIXglXwkUhOOAoL26sIeIhJWSQydCq4SAA+NGuWOpVvlVuzelujouRZYW';
        const scoresContainer = document.getElementById('scores-container');
        const errorMessage = document.getElementById('error-message');
        const lastUpdatedText = document.getElementById('last-updated');

        /**
         * Fetches all necessary data (scores, lines) and triggers rendering.
         */
        async function fetchScores() {
            errorMessage.classList.add('hidden');
            const currentYear = new Date().getFullYear();
            const headers = { 'Authorization': `Bearer ${apiKey}` };

            const safeFetchJson = async (url, options) => {
                const response = await fetch(url, options);
                if (!response.ok) { throw new Error(`API Error (${response.status}) on ${url}`); }
                try {
                    return await response.json();
                } catch (e) {
                    console.error("Failed to parse JSON for url:", url);
                    throw new Error("Received an invalid response from the server.");
                }
            };

            try {
                const calendarUrl = `https://api.collegefootballdata.com/calendar?year=${currentYear}`;
                const calendarData = await safeFetchJson(calendarUrl, { headers });
                
                const now = new Date();
                const currentWeekData = calendarData.find(week => {
                    const startDate = new Date(week.firstGameStart);
                    const endDate = new Date(week.lastGameStart);
                    endDate.setDate(endDate.getDate() + 1);
                    return now >= startDate && now < endDate;
                });

                if (!currentWeekData?.week) {
                    displayMessage("Could not determine the current college football week. It may be the offseason.");
                    return;
                }
                const { week, seasonType } = currentWeekData;

                const scoreboardUrl = 'https://api.collegefootballdata.com/scoreboard?classification=fbs';
                const linesUrl = `https://api.collegefootballdata.com/lines?year=${currentYear}&week=${week}&seasonType=${seasonType}`;

                const [allGames, linesData] = await Promise.all([
                    safeFetchJson(scoreboardUrl, { headers }),
                    safeFetchJson(linesUrl, { headers })
                ]);

                const linesMap = {};
                linesData.forEach(game => {
                    if (game.lines && game.lines.length > 0) {
                        linesMap[String(game.id)] = game.lines[0];
                    }
                });
                
                renderScores(allGames, linesMap);
                updateLastUpdatedTime();

            } catch (error) {
                console.error('Failed to fetch data:', error);
                displayError(error.message || 'Could not load scores.');
            }
        }

        /**
         * Renders the game data onto the page.
         */
        function renderScores(games, lines) {
            scoresContainer.innerHTML = '';

            if (games.length === 0) {
                displayMessage("No games scheduled for today.");
                return;
            }
            
            games.sort((a, b) => {
                const aSort = getGameSortValue(a);
                const bSort = getGameSortValue(b);
                if (aSort !== bSort) {
                    return bSort - aSort; // Sort descending
                }
                if (a.status === 'Scheduled') {
                    return new Date(a.startDate) - new Date(b.startDate);
                }
                return 0;
            });

            games.forEach(game => {
                if (!game.homeTeam || !game.awayTeam) return;

                const isGameHighlighted = isHighlighted(game);
                const gameLines = lines[game.id] || {};
                
                let cardClasses = 'bg-gray-800 border border-gray-700 p-4 rounded-xl shadow-lg transition-transform duration-300 hover:-translate-y-1';
                if (isGameHighlighted) {
                    cardClasses = 'bg-blue-900/60 border-2 border-blue-500 p-4 rounded-xl shadow-lg transition-transform duration-300 hover:-translate-y-1';
                }
                if (game.status === 'Final') {
                    cardClasses += ' opacity-60';
                }

                let statusText = '';
                let clockText = '';

                const status = (game.status || '').toLowerCase();
                
                if (isGameInProgress(game)) {
                    statusText = `Q${game.period ?? '-'}`;
                    clockText = game.clock?.displayValue ?? '-';
                } else if (status === 'final') {
                    statusText = 'Final';
                } else if (status === 'scheduled') {
                    statusText = new Date(game.startDate).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                } else {
                    statusText = game.status; // Fallback for Canceled, etc.
                }


                const homeHasPossession = game.possession === game.homeTeam.id;
                const awayHasPossession = game.possession === game.awayTeam.id;

                const cardHtml = `
                    <div class="${cardClasses}">
                        <div class="flex justify-between items-center text-sm text-gray-400 mb-3 pb-2 border-b border-gray-700">
                            <span class="font-bold text-base ${isGameHighlighted ? 'text-white' : ''}">${statusText}</span>
                            <span class="font-mono text-base ${isGameHighlighted ? 'text-white' : ''}">${clockText}</span>
                        </div>
                        ${createTeamHtml(game.awayTeam, awayHasPossession)}
                        ${createTeamHtml(game.homeTeam, homeHasPossession)}

                        <div class="mt-4 pt-2 border-t border-gray-700 text-xs text-gray-400 flex justify-between items-center">
                            <div>
                                ${game.conferenceGame ? '<span class="font-semibold text-blue-400">Conference Game</span>' : '<span>Non-Conference</span>'}
                            </div>
                            <div class="text-right">
                                ${gameLines.formattedSpread ? `<div class="font-mono">Spread: ${gameLines.formattedSpread}</div>` : ''}
                                ${gameLines.overUnder ? `<div class="font-mono">O/U: ${gameLines.overUnder}</div>` : ''}
                            </div>
                        </div>
                    </div>`;
                scoresContainer.innerHTML += cardHtml;
            });
        }
        
        /**
         * Checks if a game is currently in progress, handling multiple status variations.
         * @param {object} game - The game object from the API.
         * @returns {boolean}
         */
        function isGameInProgress(game) {
            const status = (game.status || '').toLowerCase().replace(/[\s_]/g, ''); // Normalize status by removing spaces and underscores
            return status === 'inprogress' || status === 'inprogres';
        }

        function getGameSortValue(game) {
            if (isGameInProgress(game)) {
                return isHighlighted(game) ? 4 : 3;
            }
            const status = (game.status || '').toLowerCase();
            if (status === 'scheduled') return 2;
            if (status === 'final') return 1;
            return 0;
        }

        function isHighlighted(game) {
            if (!game.homeTeam || !game.awayTeam || !isGameInProgress(game)) return false;
            
            const isSecondHalf = game.period > 2;
            const scoreDifference = Math.abs((game.homeTeam.points ?? 0) - (game.awayTeam.points ?? 0));
            const isOneScoreGame = scoreDifference <= 8;
            return isSecondHalf && isOneScoreGame;
        }

        function createTeamHtml(team, hasPossession) {
            if (!team) return '';
            const teamName = team.school || team.name || 'TEAM';
            const score = team.points ?? 0;
            const logoUrl = team.logo || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            const possessionClass = hasPossession ? 'text-yellow-400 font-bold' : 'font-semibold text-white';

            return `
                <div class="flex items-center justify-between mb-2 text-lg">
                    <div class="flex items-center gap-3">
                        <img src="${logoUrl}" alt="${teamName} logo" class="team-logo" onerror="this.style.display='none'">
                        <span class="${possessionClass}">${teamName}</span>
                    </div>
                    <span class="text-xl font-bold text-white">${score}</span>
                </div>`;
        }
        
        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            lastUpdatedText.textContent = `Last updated: ${timeString}`;
        }

        function displayError(message) {
            scoresContainer.innerHTML = '';
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function displayMessage(message) {
             scoresContainer.innerHTML = `<div class="col-span-full text-center p-8 text-gray-400 bg-gray-800 rounded-lg">${message}</div>`;
        }
        
        function initialize() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // Sunday is 0, Saturday is 6
            
            if (dayOfWeek === 6) {
                lastUpdatedText.textContent = 'It\'s Game Day! Fetching latest scores...';
                fetchScores();
                setInterval(fetchScores, 60000);
            } else {
                displayMessage("It's not Saturday! Check back on game day for live scores.");
                lastUpdatedText.textContent = 'Come back on Saturday for live scores!';
            }
        };

        window.onload = initialize;
    </script>

</body>
</html>

